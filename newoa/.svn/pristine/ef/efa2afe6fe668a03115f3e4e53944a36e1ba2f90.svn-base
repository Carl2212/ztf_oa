var username, userid,cnname, moduleid, doctype, pageindex=1, pagesize=8;
var ssHelper = new SStorageHelper(); //sessionStorage

var listHtmlStr = '<a href="{href}" class="list-group-item">'
                     +'<h4 class="list-group-item-heading">{topic}</h4>'
                     +'<p class="list-group-item-text">{module}   {dt}</p>'
                 +'</a>';

function getNoticeList(){
	var opts = {};
	
	opts.data = {};
	opts.data.username = username;
	opts.data.userid = userid;
//	opts.data.doctype = doctype;
	opts.data.moduleid = 'PublishInfo';
	opts.data.pageindex = pageindex++;
	opts.data.pagesize = (getcount&&''!=getcount&&null!=getcount)?getcount:pagesize;
	opts.data.qybm = Config.global_qybm;
	opts.data.xmbm = Config.global_xmbm;
	opts.url = Config.global_url + Config.noticelist_action;
	opts.success = function(data,status, jqXHR){
		if("1"==data.header.code){
			var listDom = $("#list");
			var href = "";
			var _count=0;
			$.each(data.result.noticelist, function(idx, doc){
				var hasData = false;
				var docItem = {};
				$.each(doc, function(idx1, viewItem){
					hasData = true;
					docItem[viewItem.name] = viewItem.text==null?'': viewItem.text.replace(new RegExp('<','gm'),'&lt;').replace(new RegExp('>','gm'),'&gt;');
				});
				
				if(hasData){
					href = 'noticedetail.html?moduleid='+docItem['moduleid'] + '&noticeid='+docItem['noticeid'];
					tmp = listHtmlStr.replace("{topic}", docItem['title']).replace("{module}", docItem['pTypeName']).replace("{dt}", docItem['pubtime']).replace("{href}", href);
					listDom.append(tmp);
					_count++;
				}
				
			});
			
			if(_count<pagesize||(getcount&&''!=getcount&&null!=getcount)){
				$("#loadmoreBtn").hide();
			}else{
				$("#loadmoreBtn").show();
			}
		}
		
	};
	
	$.jsonPost(opts);
};

function saveUser(){
	ssHelper.save('userid', userid);
    ssHelper.save('username', username);
    ssHelper.save('cnname', cnname);
};

function getUsername(callback){
	var opts = {};
	
	opts.data = {};
	opts.url = Config.global_url + Config.current_user_action;
	opts.success = function(data,status, jqXHR){
		console.log(data);
		if("1"==data.header.code){
			username = data.body;
            callback&&callback();
		}else{
			alert('您尚未登录或登录信息已过期！');
		}
	};
	
	if(Config.author_check){
		$.jsonPost(opts);
	}else{
		username = getURLParam('username');
		callback&&callback();
	}
	
};

function doLogin(callback){
//	var formData = $('#loginForm').serializeObject();
//	console.log(formData);
	var opts = {};
	
	opts.data = {};
	opts.data.username = username;
//	opts.data.password = password;
	opts.data.qybm = Config.global_qybm;
	opts.data.xmbm = Config.global_xmbm;
	opts.url = Config.global_url + Config.login_action;
	opts.success = function(data,status, jqXHR){
		if("1"==data.header.code){
			var userList = data.result.userlist;
			var user = {};
            $.each(userList, function(idx,item){
            	if(idx==0){
            		$.each(item,function(_idx, userinfo){
            			user[userinfo.name] = userinfo.text;
                    	
            		});
                	console.log(user);
            	}
            	
            });
            userid = user['userid'];
            cnname = user['cnname'];
            showBg(cnname);
            saveUser();
            callback&&callback(userid);
		}
	};
	
	$.jsonPost(opts);
};

function showBg(_name){
	var bgs = $("span[role=bg]");
//	console.log(bgs);
	$.each(bgs,function(idx, item){
		$(item).html(_name);
	});
};

$(function(){	
	moduleid = getURLParam('moduleid');
	doctype = getURLParam('doctype');
	getcount = getURLParam('getcount');
	$(".cdc-scroll-panel-body").height($(window).height()-90);
	
	userid = ssHelper.getValue('userid');
	username = ssHelper.getValue('username');
	$("#loadmoreBtn").on('click', function(){
		$("#loadmoreBtn").hide();
		getNoticeList();
	});
//	getNoticeList();
	
	getUsername(function(){
		doLogin(function(userid){
			getNoticeList();
			
			
		});
	})
	
	
});